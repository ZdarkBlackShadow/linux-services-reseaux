# Configuration de pfsense graphique

Tout d'abord, il vous faudra créer une nouvelle VM graphique (Debian) dans le réseau LAN de votre routeur (192.168.100.x) en étant connecté au réseau vmbr0 (pour pouvoir installer tout ce qui est nécessaire via internet). Puis éteignez votre VM, changez votre carte réseau sur vmbr1 pour passer sur la connexion via le routeur. Redémarrez la.  

Une fois cela fait, vous n'aurez plus accès à internet, mais devriez pouvoir avoir accès au panneau de connexion pfsense admin sur navigateur. 

Pour garantir l'accès au routeur même si le service DHCP est inactif, nous configurons une IP statique.  

Ouvrez un terminal sur la VM graphique.
Passez en root sur la VM, puis accédez au fichier nano /etc/network/interfaces
Insérez la configuration suivante :

### Interface LAN (VM Alexis)

```
auto ens18
allow-hotplug ens18
iface ens18 inet static
    address 192.168.100.50       # IP fixe du client
    netmask 255.255.255.0        # Masque /24
    gateway 192.168.100.1        # Adresse du pfSense (Porte de sortie)
    dns-nameservers 1.1.1.1 8.8.8.8
```
Ensuite, appliquez ces changements en tapant la commande :
```
systemctl restart networking
```
Pour tester si cela a fonctionné :
```
ping 192.168.100.x
```

Passez par l'adresse que vous à donner pfsense sur console (https://192.168.100.x)  
Attention à ne pas oublier le "s" de https.  

Par défaut, la connexion se fait avec user : admin et mdp : pfsense. Changez vite le mot de passe pour un mot de passe plus sécurisé avant de passer à autre chose.  

(En cas de problèmes, se référer à la partie Troubleshooting)

### Nous allons maintenant fixer les règles de firewall.  

Comment créer une nouvelle règle  

Pour ajouter une règle (autoriser ou bloquer un trafic), voici comment faire :  

    Menu : Cliquer sur Firewall dans le menu du haut, puis sur Rules.  

    Ajouter : Clique sur le bouton Add :  

        Flèche haut : Pour placer la règle au début (Priorité haute).  

        Flèche bas : Pour placer la règle à la fin (Priorité basse).  

        pfSense lit les règles de haut en bas. La première qui correspond gagne.  

    Configuration de la règle :  

        Action : Pass (Autoriser), Block (Bloquer sans rien dire) ou Reject (Bloquer en signalant l'erreur).  

        Protocol : TCP (Web, SSH...), UDP (DNS, Streaming, VPN...) ou Any (Tout).  

        Source : Qui envoie la requête ? (Ex: LAN net pour tout le réseau).  

        Destination : Vers où ? (Ex: Any pour Internet, ou une IP précise).  

        Destination Port Range : (Optionnel) Le port ciblé (ex: 443 pour HTTPS).  

    Validation :  

        Cliquer sur le bouton bleu Save.  

        Une barre verte va apparaître en haut. 
         Cliquer sur Apply Changes pour que la règle s'active réellement.  

### Les règles que nous avons mises en place (LAN)  

Règle N°1 : Anti-Lockout Rule  

    Elle autorise le trafic vers l'adresse IP du pfSense (LAN Address) sur les ports 443 (HTTPS), 80 (HTTP) et 22 (SSH).  

    PfSense ajoute cette règle automatiquement et la place tout en haut. Elle garantit que, quoi que l'on fasses (même si on crée une règle "Bloquer TOUT" par erreur), on aura toujours accès à l'interface d'administration pour réparer d'éventuelles bêtises. Elle empêche de s'enfermer dehors.  

Règle N°2 : Default allow LAN to any rule (IPv4)  

    Elle autorise tout le trafic venant du réseau local (LAN) vers n'importe où (Any).  

    C'est la règle d'accès à Internet.  

    Par défaut, pfSense interdit tout (principe du "Default Deny"). Sans cette ligne, la VM serait isolée : impossible de sortir sur Google ou de faire des mises à jour. Cette règle permet l'accès vers l'extérieur.  

Règle N°3 : Default allow LAN IPv6 to any rule  

    Accès Internet pour l'IPv6.  

    Elle est créée par défaut. Dans ce cas (IPv4), elle ne sert pas, mais elle ne gêne pas.  


### Les règles que nous avons mises en place (LAN2)  

Règle N°1 : Bloquer l'accès Admin** (Croix Rouge)
* **Configuration :** Action `Block` | Source `LAN2 subnets` | Destination `LAN subnets`.
* **Fonction :** Elle interdit formellement à toute machine du réseau LAN2 de communiquer avec le réseau LAN principal.
* **Pourquoi ?** C'est une règle de **segmentation**. Si un équipement dans cette zone est compromis (ex: le Bastion), l'attaquant reste bloqué dans le LAN2 et ne peut pas atteindre nos serveurs sensibles situés sur le LAN.

**Règle N°2 : Internet OK** (Coche Verte)
* **Configuration :** Action `Pass` | Source `LAN2 subnets` | Destination `*` (Any).
* **Fonction :** Elle autorise les machines du LAN2 à accéder à tout le reste (principalement Internet).
* **Pourquoi ?** Elle permet aux invités ou au Bastion d'accéder au Web pour les mises à jour ou la navigation.

### Ce que l'on ne vois pas  

Il y a deux concepts invisibles sur cette page qu'il faut connaître pour pfsense :  

    La règle "Tout Bloquer" (Default Deny) : Tout en bas de la liste, il y a une règle invisible qui dit "Tout ce qui n'a pas été autorisé au-dessus est INTERDIT". C'est pour ça que si on supprime la règle n°2, nous n'avons plus Internet.  

    Le retour automatique (Stateful) : Pas besoin de créer de règle pour le "retour" des données (d'Internet vers le PC). PfSense se souvient que c'est nous qui avons initié la connexion et laisse passer la réponse automatiquement.  
